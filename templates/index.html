{% extends "layout.html" %}
{% block content %}

<style>
/* Container & layout */
.container { max-width: 1200px; margin-top: 30px; }
.two-pane { display: flex; gap: 30px; flex-wrap: wrap; }
.pane {
    flex: 1;
    min-width: 320px;
    background: #fff;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 6px 25px rgba(0,0,0,.1);
}

/* Scanner box */
.scanner-box {
    position: relative;
    border: 2px dashed #ccc; /* Ash colored border */
    height: 300px;
    border-radius: 12px;
    overflow: hidden;
    text-align: center;
    background: rgba(220, 220, 220, 0.1); /* Slight transparent background */
}

.scanner-line {
    position: absolute;
    width: 100%;
    height: 10px; /* Wider line */
    background: #aaa; /* Ash color */
    animation: scan 2s linear infinite;
}

@keyframes scan {
    0% { top: 0; }
    50% { top: 100%; }
    100% { top: 0; }
}

.hidden { display: none; }
</style>

<div class="container">
    <h2 class="text-center text-danger mb-4">
         AI-Based Malaria Detection System
    </h2>

    <div class="two-pane">

        <!-- LEFT PANE: Info / Hospital -->
        <div class="pane">
            <h4>üè• University Teaching Hospital</h4>
            <hr>
            <p><strong>AI Malaria Diagnostic Unit</strong></p>

            <ul>
                <li>‚úî WHO-Compliant Screening</li>
                <li>‚úî Blood Smear Image Analysis</li>
                <li>‚úî Fast & Accurate Results</li>
            </ul>

            <p class="mt-3">
                <strong>Consultant:</strong><br>
                Dr. A. B. Okafor<br>
                MBBS, FMCPath
            </p>

            <p>
                <strong>Address:</strong><br>
                123 University Road, Cityville, State<br>
                <strong>Phone:</strong> +234 800 123 4567
            </p>

            <div class="alert alert-warning mt-3">
                ‚ö† This AI system assists diagnosis. Final confirmation must be done by a medical professional.
            </div>
        </div>

        <!-- RIGHT PANE: Malaria Scan -->
        <div class="pane">

            <h4>üî¨ Patient Malaria Scan</h4>

            <input class="form-control mb-2" id="fullname"
                   placeholder="Patient Full Name" value="">

            <input class="form-control mb-3" id="patient_id"
                   placeholder="Patient ID" value="">

            <input type="file" id="imageUpload"
                   class="form-control mb-3"
                   accept=".jpg,.png,.jpeg">

            <!-- Scanner -->
            <div class="scanner-box hidden" id="scanner">
                <div class="scanner-line"></div>
                <p class="mt-5 text-secondary">
                    Scanning Blood Smear Image...
                </p>
                <p>Please wait</p>
            </div>

            <!-- Result -->
            <div id="resultBox" class="hidden mt-3"></div>

            <button class="btn btn-danger w-100 mt-3"
                    onclick="startScan()">
                ‚ñ∂ Start Scan
            </button>

            <button class="btn btn-outline-success w-100 mt-2 hidden"
                    id="pdfBtn"
                    onclick="downloadPDF()">
                üìÑ Download Medical Report
            </button>
        </div>

    </div>
</div>

<script>
function startScan() {
    const name = document.getElementById("fullname").value;
    const id = document.getElementById("patient_id").value;
    const file = document.getElementById("imageUpload").files[0];

    if (!name || !id || !file) {
        alert("Please enter patient details and upload scan image");
        return;
    }

    // Show scanner
    document.getElementById("scanner").classList.remove("hidden");

    const formData = new FormData();
    formData.append("file", file);
    formData.append("fullname", name);
    formData.append("patient_id", id);

    fetch("/predict", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
            document.getElementById("scanner").classList.add("hidden");

            document.getElementById("resultBox").innerHTML = `
                <div class="alert alert-info">
                    <strong>Diagnosis:</strong> ${data.prediction.label}<br>
                    <strong>Confidence:</strong> ${data.prediction.confidence.toFixed(2)}%<br><br>
                    <strong>Patient Name:</strong> ${name}<br>
                    <strong>Patient ID:</strong> ${id}<br>
                    <strong>Consultant:</strong> Dr. A. B. Okafor<br>
                    <strong>Hospital:</strong> University Teaching Hospital<br>
                    <strong>Address:</strong> 123 University Road, Cityville, State<br>
                    <strong>Phone:</strong> +234 800 123 4567<br><br>
                    <em>Scan Image Copy:</em><br>
                    <img src="${URL.createObjectURL(file)}" class="img-fluid mt-2" style="max-height:200px; border-radius:10px;">
                </div>
            `;
            document.getElementById("resultBox").classList.remove("hidden");
            document.getElementById("pdfBtn").classList.remove("hidden");
        });
}

function downloadPDF() {
    window.location.href = "/download_report";
}
</script>

{% endblock %}
